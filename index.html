<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Si-3.26 –ê–Ω–∞–ª–∏—Ç–∏–∫ | MOEX Real-Time Fix</title>
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg: #0d1117;
            --card: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --accent: #8957e5;
            --buy: #238636;
            --sell: #f85149;
            --live: #3fb950;
            --warning: #f0883e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 12px;
            min-height: 100vh;
        }

        h2 {
            text-align: center;
            font-size: clamp(1.2rem, 5vw, 1.8rem);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        #chart {
            height: 400px;
            width: 100%;
            position: relative;
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
        }

        .timeframe-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .tf-btn {
            background: transparent;
            color: var(--text);
            border: 1px solid transparent;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.7;
        }

        .tf-btn.active {
            background: var(--accent);
            color: white;
            opacity: 1;
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(137, 87, 229, 0.4);
        }

        .tf-btn:hover {
            opacity: 1;
            background: rgba(137, 87, 229, 0.2);
            border-color: var(--accent);
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(63, 185, 80, 0.2);
            color: var(--live);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--live);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .live-dot.warning {
            background: var(--warning);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 8px;
            font-size: 12px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: #0d1117;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .status-item.online { border-color: var(--live); color: var(--live); }
        .status-item.warning { border-color: var(--warning); color: var(--warning); }
        .status-item.error { border-color: var(--sell); color: var(--sell); }

        .delay-warning {
            background: rgba(240, 136, 62, 0.2);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            margin-top: 8px;
            text-align: center;
            display: none;
        }

        .delay-warning.visible { display: block; }

        .price-ticker {
            display: flex;
            justify-content: space-around;
            margin: 12px 0;
            padding: 12px;
            background: #0d1117;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .ticker-item { text-align: center; }
        .ticker-label { font-size: 11px; color: #8b949e; text-transform: uppercase; margin-bottom: 4px; }
        .ticker-value { font-size: 20px; font-weight: 700; font-family: monospace; }
        .ticker-change { font-size: 12px; margin-top: 2px; }
        .positive { color: #3fb950; }
        .negative { color: #f85149; }

        .signal-display {
            text-align: center;
            padding: 16px;
            border-radius: 16px;
            border: 2px solid var(--border);
            margin-bottom: 16px;
            transition: all 0.3s;
        }

        .signal-display.buy { border-color: var(--buy); color: #3fb950; background: rgba(35, 134, 54, 0.15); }
        .signal-display.sell { border-color: var(--sell); color: var(--sell); background: rgba(248, 81, 73, 0.15); }
        .signal-display.hold { border-color: #8b949e; color: #8b949e; }

        .auto-update-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0;
            padding: 8px 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .timer {
            background: #21262d;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            font-family: monospace;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px 16px;
            cursor: pointer;
            border-radius: 14px;
            width: 100%;
            font-weight: 600;
            font-size: 16px;
            margin-top: 10px;
            transition: all 0.2s;
        }

        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button.small { background: #21262d; padding: 10px; font-size: 14px; margin-top: 8px; }
        button.small.active { background: var(--accent); }

        .info {
            font-size: 13px;
            color: #8b949e;
            margin: 10px 0 0;
            line-height: 1.5;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card);
            padding: 12px 24px;
            border-radius: 40px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px black;
            white-space: nowrap;
            font-size: 14px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .debug-info {
            font-family: monospace;
            font-size: 11px;
            color: #8b949e;
            background: #0d1117;
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
            max-height: 100px;
            overflow-y: auto;
        }

        @media (max-width: 1100px) {
            .grid { grid-template-columns: 1fr; }
            #chart { height: 350px; }
        }

        @media (max-width: 600px) {
            body { padding: 8px; }
            .card { padding: 12px; }
            .tf-btn { padding: 6px 10px; font-size: 12px; }
            #chart { height: 280px; }
        }
    </style>
</head>
<body>
    <h2>
        –ê–Ω–∞–ª–∏–∑ Si-3.26 (H6) 
        <span class="live-indicator" id="liveIndicator">
            <span class="live-dot" id="liveDot"></span>
            <span id="liveText">LIVE</span>
        </span>
    </h2>

    <div class="grid">
        <div class="card">
            <div class="timeframe-selector" id="tfSelector">
                <button class="tf-btn" data-tf="1" type="button">M1</button>
                <button class="tf-btn" data-tf="10" type="button">M10</button>
                <button class="tf-btn active" data-tf="60" type="button">1H</button>
                <button class="tf-btn" data-tf="240" type="button">4H</button>
                <button class="tf-btn" data-tf="1440" type="button">1D</button>
            </div>
            
            <div id="chart">
                <div id="loading"><div class="spinner"></div> –ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            
            <div class="status-bar">
                <div class="status-item" id="statusConnection">
                    <span>‚óè</span>
                    <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                </div>
                <div class="status-item">
                    <span>–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–≤–µ—á–∞:</span>
                    <span id="lastCandleTime">-</span>
                </div>
                <div class="status-item">
                    <span>–ó–∞–¥–µ—Ä–∂–∫–∞:</span>
                    <span id="delayTime">-</span>
                </div>
                <div class="status-item">
                    <span>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</span>
                    <span id="updateTime">-</span>
                </div>
            </div>
            
            <div class="delay-warning" id="delayWarning">
                ‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –æ—Ç—Å—Ç–∞—é—Ç –Ω–∞ <span id="delayMinutes">0</span> –º–∏–Ω—É—Ç! 
                MOEX API –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø.
            </div>

            <div class="debug-info" id="debugInfo"></div>
        </div>

        <div class="side">
            <div class="card">
                <div class="price-ticker">
                    <div class="ticker-item">
                        <div class="ticker-label">–¶–µ–Ω–∞</div>
                        <div class="ticker-value" id="currentPrice">-</div>
                        <div class="ticker-change" id="priceChange">-</div>
                    </div>
                    <div class="ticker-item">
                        <div class="ticker-label">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</div>
                        <div class="ticker-value" id="changePercent">-</div>
                    </div>
                </div>

                <div id="signal_ui" class="signal-display hold">
                    <div style="font-size: 11px; opacity: 0.7;">–¢–ï–ö–£–©–ò–ô –°–ò–ì–ù–ê–õ</div>
                    <div id="signal_text" style="font-size: 26px; font-weight: bold;">–û–ñ–ò–î–ê–ù–ò–ï</div>
                </div>

                <div class="auto-update-row">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="autoUpdateCheck" checked> 
                        –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (10 —Å–µ–∫)
                    </label>
                    <span class="timer" id="timerDisplay">00:10</span>
                </div>

                <button onclick="forceRefresh()" type="button">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <button class="small" onclick="testAlternateSource()" type="button">
                    üì° –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                </button>
            </div>

            <div class="card" style="margin-top: 16px;">
                <div class="info">
                    <strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> MOEX ISS API –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –æ—Ç–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 15-30 –º–∏–Ω—É—Ç –≤–æ –≤–Ω–µ —Ç–æ—Ä–≥–æ–≤–æ–µ –≤—Ä–µ–º—è –∏ 2-5 –º–∏–Ω—É—Ç –≤ —Ç–æ—Ä–≥–æ–≤–æ–µ –≤—Ä–µ–º—è.
                    <br><br>
                    <strong>–†–µ—à–µ–Ω–∏—è:</strong><br>
                    1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä)<br>
                    2. –ü–∞—Ä—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ Quik/MT5<br>
                    3. –ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ MOEX
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        // ============================================
        const CONFIG = {
            TICKER: 'SiH6',
            UPDATE_INTERVAL: 10, // —Å–µ–∫—É–Ω–¥ - —á–∞—â–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            MAX_DELAY_MINUTES: 5, // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
            TF_MAP: { 1: 1, 10: 10, 60: 60, 240: 24, 1440: 'D' }
        };

        // ============================================
        // –°–û–°–¢–û–Ø–ù–ò–ï
        // ============================================
        const state = {
            currentTf: 60,
            chartData: [],
            chart: null,
            series: null,
            lastUpdate: 0,
            isTradingHours: false
        };

        // ============================================
        // –£–¢–ò–õ–ò–¢–´ –í–†–ï–ú–ï–ù–ò (–ú–û–°–ö–í–ê)
        // ============================================
        function getMoscowDate() {
            return new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Moscow" }));
        }

        function formatMoscowTime(date) {
            return date.toLocaleTimeString('ru-RU', { 
                timeZone: 'Europe/Moscow',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function formatMoscowDateTime(date) {
            return date.toLocaleString('ru-RU', { 
                timeZone: 'Europe/Moscow',
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit', 
                minute: '2-digit'
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—Ä–≥–æ–≤—ã—Ö —á–∞—Å–æ–≤ MOEX (—Ñ—å—é—á–µ—Ä—Å—ã)
        function checkTradingHours() {
            const msk = getMoscowDate();
            const hour = msk.getHours();
            const day = msk.getDay();
            
            // –§—å—é—á–µ—Ä—Å—ã: 10:00 - 23:50 –ú–°–ö, –ø–Ω-–ø—Ç (–¥–µ–Ω—å), –≤—Å (–≤–µ—á–µ—Ä–Ω—è—è —Å–µ—Å—Å–∏—è)
            // –£–ø—Ä–æ—â—ë–Ω–Ω–æ: 10:00-23:50
            const isTrading = day >= 1 && day <= 5 && hour >= 10 && hour < 24;
            state.isTradingHours = isTrading;
            return isTrading;
        }

        // ============================================
        // –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
        // ============================================
        function log(...args) {
            const time = formatMoscowTime(getMoscowDate());
            console.log(`[${time}]`, ...args);
            
            const debugEl = document.getElementById('debugInfo');
            const line = `[${time}] ${args.join(' ')}`;
            debugEl.innerHTML = line + '<br>' + debugEl.innerHTML;
            if (debugEl.innerHTML.length > 500) {
                debugEl.innerHTML = debugEl.innerHTML.substring(0, 500);
            }
        }

        // ============================================
        // –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò
        // ============================================
        async function loadData(timeframe = state.currentTf, force = false) {
            const loadingEl = document.getElementById('loading');
            const interval = CONFIG.TF_MAP[timeframe];
            
            if (!interval) {
                log('Error: Invalid timeframe', timeframe);
                return;
            }

            if (!force) loadingEl.style.display = 'flex';

            // –†–∞—Å—á—ë—Ç –ø–µ—Ä–∏–æ–¥–∞
            let daysBack = 3;
            if (timeframe === 1) daysBack = 1;
            else if (timeframe === 10) daysBack = 2;
            else if (timeframe === 60) daysBack = 7;
            else if (timeframe === 240) daysBack = 14;
            else if (timeframe === 1440) daysBack = 30;

            const from = new Date(getMoscowDate());
            from.setDate(from.getDate() - daysBack);
            
            const till = new Date(getMoscowDate());
            till.setDate(till.getDate() + 1);

            // –ö–õ–Æ–ß–ï–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫—ç—à–∞
            const cacheBuster = Date.now();
            const url = `https://iss.moex.com/iss/engines/futures/markets/forts/securities/${CONFIG.TICKER}/candles.json?interval=${interval}&from=${formatDate(from)}&till=${formatDate(till)}&_=${cacheBuster}`;

            log('Fetching:', { timeframe, interval, url: url.substring(0, 60) + '...' });

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                
                if (!data.candles?.data?.length) {
                    throw new Error('No data in response');
                }

                // –ü–∞—Ä—Å–∏–Ω–≥
                const cols = data.candles.columns;
                const idx = {
                    open: cols.indexOf('open'),
                    close: cols.indexOf('close'),
                    high: cols.indexOf('high'),
                    low: cols.indexOf('low'),
                    begin: cols.indexOf('begin'),
                    end: cols.indexOf('end')
                };

                const parsed = data.candles.data.map(c => ({
                    time: Math.floor(new Date(c[idx.begin]).getTime() / 1000),
                    timeEnd: c[idx.end],
                    open: parseFloat(c[idx.open]),
                    high: parseFloat(c[idx.high]),
                    low: parseFloat(c[idx.low]),
                    close: parseFloat(c[idx.close])
                })).filter(c => !isNaN(c.close));

                parsed.sort((a, b) => a.time - b.time);

                if (parsed.length === 0) throw new Error('No valid candles');

                const lastCandle = parsed[parsed.length - 1];
                const lastCandleTime = new Date(lastCandle.time * 1000);
                const now = getMoscowDate();
                
                // –†–∞—Å—á—ë—Ç –∑–∞–¥–µ—Ä–∂–∫–∏
                const delayMs = now - lastCandleTime;
                const delayMinutes = Math.floor(delayMs / 60000);
                
                log('Data received:', {
                    candles: parsed.length,
                    lastCandle: formatMoscowDateTime(lastCandleTime),
                    serverTime: formatMoscowDateTime(now),
                    delay: `${delayMinutes} –º–∏–Ω`,
                    lastClose: lastCandle.close
                });

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                state.chartData = parsed;
                state.lastUpdate = Date.now();

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                updateChart(parsed);
                updateTicker(parsed);
                updateStatus(true, lastCandleTime, delayMinutes);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–µ—Ä–∂–∫–∏
                if (delayMinutes > CONFIG.MAX_DELAY_MINUTES) {
                    showDelayWarning(delayMinutes);
                } else {
                    hideDelayWarning();
                }

                if (!force) loadingEl.style.display = 'none';

            } catch (err) {
                log('Error:', err.message);
                if (!force) {
                    loadingEl.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
                    updateStatus(false);
                }
            }
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // ============================================
        // –ì–†–ê–§–ò–ö
        // ============================================
        function updateChart(data) {
            if (!state.chart) {
                const container = document.getElementById('chart');
                document.getElementById('loading').style.display = 'none';
                
                state.chart = LightweightCharts.createChart(container, {
                    layout: { background: { color: '#161b22' }, textColor: '#d1d4dc' },
                    grid: { vertLines: { color: '#30363d' }, horzLines: { color: '#30363d' } },
                    timeScale: { 
                        borderColor: '#30363d', 
                        timeVisible: true,
                        rightOffset: 10
                    },
                    width: container.clientWidth,
                    height: 400
                });

                state.series = state.chart.addCandlestickSeries({
                    upColor: '#238636',
                    downColor: '#f85149',
                    borderVisible: false,
                    wickVisible: true
                });

                window.addEventListener('resize', () => {
                    state.chart.applyOptions({ width: container.clientWidth });
                });
            }

            state.series.setData(data);
            state.chart.timeScale().fitContent();
        }

        function updateTicker(data) {
            if (!data.length) return;
            
            const last = data[data.length - 1];
            const prev = data[data.length - 2] || last;
            const change = last.close - prev.close;
            const changePct = (change / prev.close) * 100;

            document.getElementById('currentPrice').innerText = last.close.toFixed(2);
            
            const sign = change >= 0 ? '+' : '';
            const cls = change >= 0 ? 'positive' : 'negative';
            
            document.getElementById('priceChange').innerText = `${sign}${change.toFixed(2)}`;
            document.getElementById('priceChange').className = `ticker-change ${cls}`;
            document.getElementById('changePercent').innerText = `${sign}${changePct.toFixed(2)}%`;
            document.getElementById('changePercent').className = `ticker-value ${cls}`;
        }

        function updateStatus(connected, lastCandleTime = null, delayMinutes = 0) {
            const statusEl = document.getElementById('statusConnection');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                const isDelayed = delayMinutes > CONFIG.MAX_DELAY_MINUTES;
                statusEl.className = 'status-item ' + (isDelayed ? 'warning' : 'online');
                statusText.innerText = isDelayed ? '–ó–∞–¥–µ—Ä–∂–∫–∞' : '–û–Ω–ª–∞–π–Ω';
                
                document.getElementById('lastCandleTime').innerText = formatMoscowDateTime(lastCandleTime);
                document.getElementById('delayTime').innerText = `${delayMinutes} –º–∏–Ω`;
                document.getElementById('updateTime').innerText = formatMoscowTime(getMoscowDate());
                
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä LIVE
                const liveDot = document.getElementById('liveDot');
                const liveText = document.getElementById('liveText');
                if (isDelayed) {
                    liveDot.className = 'live-dot warning';
                    liveText.innerText = 'DELAY';
                } else {
                    liveDot.className = 'live-dot';
                    liveText.innerText = 'LIVE';
                }
            } else {
                statusEl.className = 'status-item error';
                statusText.innerText = '–û—à–∏–±–∫–∞';
            }
        }

        function showDelayWarning(minutes) {
            document.getElementById('delayWarning').classList.add('visible');
            document.getElementById('delayMinutes').innerText = minutes;
        }

        function hideDelayWarning() {
            document.getElementById('delayWarning').classList.remove('visible');
        }

        // ============================================
        // –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï
        // ============================================
        let updateTimer = null;
        let countdownTimer = null;

        function startAutoUpdate() {
            stopAutoUpdate();
            
            updateTimer = setInterval(() => {
                if (document.getElementById('autoUpdateCheck').checked) {
                    loadData(state.currentTf, true);
                }
            }, CONFIG.UPDATE_INTERVAL * 1000);

            let countdown = CONFIG.UPDATE_INTERVAL;
            document.getElementById('timerDisplay').innerText = `00:${countdown.toString().padStart(2, '0')}`;
            
            countdownTimer = setInterval(() => {
                if (document.getElementById('autoUpdateCheck').checked) {
                    countdown--;
                    if (countdown <= 0) countdown = CONFIG.UPDATE_INTERVAL;
                    document.getElementById('timerDisplay').innerText = `00:${countdown.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function stopAutoUpdate() {
            if (updateTimer) clearInterval(updateTimer);
            if (countdownTimer) clearInterval(countdownTimer);
        }

        function forceRefresh() {
            log('Manual refresh triggered');
            loadData(state.currentTf, false);
        }

        // ============================================
        // –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –ò–°–¢–û–ß–ù–ò–ö (–¢–ï–°–¢)
        // ============================================
        async function testAlternateSource() {
            log('Testing alternate data sources...');
            
            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–¥–µ–ª–∫–∏ (trades) - –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–≤–µ–∂–µ–µ
            try {
                const url = `https://iss.moex.com/iss/engines/futures/markets/forts/securities/${CONFIG.TICKER}/trades.json?limit=100&_=${Date.now()}`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.trades?.data?.length) {
                    const cols = data.trades.columns;
                    const timeIdx = cols.indexOf('tradetime');
                    const priceIdx = cols.indexOf('price');
                    
                    const lastTrade = data.trades.data[data.trades.data.length - 1];
                    const tradeTime = lastTrade[timeIdx];
                    const tradePrice = lastTrade[priceIdx];
                    
                    log('Last trade:', { time: tradeTime, price: tradePrice });
                    alert(`–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞: ${tradePrice} –≤ ${tradeTime}\n\n–°–¥–µ–ª–∫–∏ –æ–±—ã—á–Ω–æ —Å–≤–µ–∂–µ–µ —Å–≤–µ—á–µ–π!`);
                }
            } catch (e) {
                log('Trades error:', e.message);
            }
        }

        // ============================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ê–ô–ú–§–†–ï–ô–ú–ê–ú–ò
        // ============================================
        function initTimeframeButtons() {
            document.getElementById('tfSelector').addEventListener('click', (e) => {
                const btn = e.target.closest('.tf-btn');
                if (!btn) return;

                const newTf = parseInt(btn.dataset.tf);
                if (newTf === state.currentTf) return;

                document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                state.currentTf = newTf;
                log('Timeframe changed:', newTf);
                loadData(newTf, false);
            });
        }

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            log('Starting... Timezone:', Intl.DateTimeFormat().resolvedOptions().timeZone);
            log('Moscow time:', formatMoscowTime(getMoscowDate()));
            log('Trading hours:', checkTradingHours() ? 'YES' : 'NO');
            
            initTimeframeButtons();
            
            // –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
            loadData(60, false).then(() => {
                startAutoUpdate();
                log('Auto-update started');
            });
        });
    </script>
</body>
</html>
